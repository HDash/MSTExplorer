#' Create interactive network plot start to finish
#'
#' This puts all the functions together from getting the subset of results
#'  to creating the final interactive plot.
#'
#' @param results The cell type-phenotype enrichment results generated by
#'  \link[MultiEWCE]{gen_results}
#'  and merged together with \link[MultiEWCE]{merge_results}.
#' @param cell_type The cell type of interest to be plotted.
#' Can be a single string (e.g. \code{"Astrocytes"}) or a character vector
#' of multiple cell types (e..g. \code{c("Astrocytes","Microglia")}).
#' Set to \code{NULL} if you wish to include all cell-types that are available
#' (after \code{q_threshold} and \code{fold_threshold} filtering).
#' If >1 cell-type remains, results will be aggregated automatically
#' such that there is only 1 node per phenotype.
#' @param q_threshold The q value threshold to subset the \code{results} by.
#' @param fold_threshold The minimum fold change in specific expression
#'  to subset the \code{results} by.
#' @inheritParams HPOExplorer::make_phenos_dataframe
#' @inheritParams HPOExplorer::ggnetwork_plot
#' @inheritParams HPOExplorer::subset_descendants
#' @inheritParams HPOExplorer::make_network_object
#' @returns A named list of outputs,
#'  including a interactive network plot of the selected subset
#' of results from RD EWCE analysis.
#'
#' @export
#' @importFrom HPOExplorer get_hpo load_phenotype_to_genes adjacency_matrix
#' @importFrom HPOExplorer make_hoverboxes make_network_object ggnetwork_plot
#' @importFrom HPOExplorer add_hpo_definition list_columns
#' @examples
#' res <- ggnetwork_plot_full(cell_type = "Microglia")
ggnetwork_plot_full <- function(cell_type,
                                ancestor = NULL,
                                results = load_example_results(),
                                hpo = HPOExplorer::get_hpo(),
                                phenotype_to_genes =
                                  HPOExplorer::load_phenotype_to_genes(),
                                q_threshold = 0.0005,
                                fold_threshold = 1,
                                columns = HPOExplorer::list_columns(),
                                colour_var = "fold_change",
                                size_var = "ontLvl_relative",
                                add_ont_lvl_absolute = TRUE,
                                add_ont_lvl_relative = TRUE,
                                interactive = TRUE,
                                verbose = TRUE){
  # templateR:::source_all()
  # devoptera::args2vars(ggnetwork_plot_full);
  # cell_type = "Microglia";
  # cell_type = NULL; ancestor = "Neurodevelopmental delay"

  messager("ggnetwork_plot_full",v=verbose)
  phenos <- subset_phenos(phenotype_to_genes = phenotype_to_genes,
                          ancestor = ancestor,
                          results = results,
                          hpo = hpo,
                          cell_type = cell_type,
                          q_threshold = q_threshold,
                          fold_threshold = fold_threshold,
                          verbose = verbose)
  #### Aggregate across multiple celltypes ####
  phenos <- agg_results(phenos = phenos,
                        count_var = "CellType",
                        group_var = "Phenotype",
                        verbose = verbose)
  #### Make adjacency matrix ####
  adjacency <- HPOExplorer::adjacency_matrix(terms = phenos$HPO_ID,
                                             hpo = hpo,
                                             verbose = verbose)
  #### Add metadata ####
  if(isTRUE(add_ont_lvl_absolute)){
    phenos <- HPOExplorer::add_ont_lvl(phenos = phenos,
                                       hpo = hpo,
                                       absolute = TRUE,
                                       verbose = verbose)
  }
  if(isTRUE(add_ont_lvl_relative)){
    phenos <- HPOExplorer::add_ont_lvl(phenos = phenos,
                                       hpo = hpo,
                                       adjacency = adjacency,
                                       absolute = FALSE,
                                       verbose = verbose)
  }
  if(!"definition" %in% names(phenos)){
    phenos <- HPOExplorer::add_hpo_definition(phenos = phenos,
                                              verbose = verbose)
  }
  if(!"hover" %in% names(phenos)){
    phenos <- HPOExplorer::make_hoverboxes(phenos = phenos,
                                           columns = columns,
                                           interactive = interactive,
                                           verbose = verbose)
  }
  #### Fix colour var for aggregated data ####
  colour_var2 <- paste0("mean_",colour_var)
  if(!colour_var %in% names(phenos) &&
     colour_var2 %in% names(phenos)){
    colour_var <- colour_var2
  }
  #### Make network ####
  phenoNet <- HPOExplorer::make_network_object(phenos = phenos,
                                               hpo = hpo,
                                               adjacency = adjacency,
                                               colour_var = colour_var,
                                               verbose = verbose)
  #### Make plot ####
  network_plot <- HPOExplorer::ggnetwork_plot(phenoNet = phenoNet,
                                              colour_var = colour_var,
                                              size_var = size_var,
                                              interactive = interactive,
                                              verbose = verbose)
  #### Return ####
  return(list(plot=network_plot,
              phenos=phenos,
              phenoNet=phenoNet,
              adjacency=adjacency
              ))
}
