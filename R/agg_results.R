#' Aggregate results
#'
#' Aggregate enrichment results from generated by \link[MultiEWCE]{gen_results}.
#' Counts unique entries in \code{count_var} while grouping by \code{group_var}.
#' @inheritParams summary_plot
#' @inheritParams HPOExplorer::make_phenos_dataframe

#' @keywords internal
#' @importFrom data.table uniqueN :=
#' @importFrom stringr str_wrap
#' @importFrom HPOExplorer add_hpo_definition
agg_results <- function(phenos,
                        count_var = "Phenotype",
                        group_var = "CellType",
                        verbose = TRUE){

  fold_change <- sd_from_mean <- . <- NULL;

  # classes <- lapply(phenos, class)
  # phenos[,count=list(
  #   data.table::uniqueN(eval(parse(text = count_var)))
  # ),
  #        ]

  messager("Aggregating results by",
           paste0("group_var=",shQuote(group_var)),v=verbose)
  counts_df <- unique(phenos[,.(
    count=data.table::uniqueN(eval(parse(text = count_var))),
    mean_fold_change=round(mean(fold_change),3),
    mean_q=round(mean(q),3),
    mean_sd_from_mean=round(mean(sd_from_mean),3),
    values=paste(
      stringr::str_wrap(paste(unique(eval(parse(text = count_var))),
                              collapse = ", ")),
      sep = "<br>")
  ),
  by=group_var][,c(group_var,
                   "count",
                   "mean_fold_change",
                   "mean_q",
                   "mean_sd_from_mean",
                   "values"), with=FALSE])
  data.table::setnames(counts_df,
                       c("count","values"),
                       c(paste(tolower(count_var),"count",sep="_"),
                         paste(tolower(count_var),"values",sep="_")
                       ))

  if(!"HPO_ID" %in% names(counts_df) &&
     "Phenotype" %in% names(counts_df)){
    counts_df <- HPOExplorer::add_hpo_id(phenos = counts_df,
                                         verbose = verbose)
  }
  return(counts_df)
}
