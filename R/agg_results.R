#' Aggregate results
#'
#' Aggregate enrichment results from generated by \link[MultiEWCE]{gen_results}.
#' Counts unique entries in \code{count_var} while grouping by \code{group_var}.
#' @param sep Separator for collapsed character columns.
#' @inheritParams summary_plot
#' @inheritParams HPOExplorer::make_phenos_dataframe
#' @inheritParams HPOExplorer::make_network_object
#' @returns Aggregated \link[data.table]{data.table}
#'
#' @export
#' @importFrom data.table uniqueN :=
#' @importFrom stringr str_wrap
#' @importFrom HPOExplorer add_hpo_definition
#' @examples
#' phenos <- subset_results(cell_type = "Microglia")
#' agg_res <- agg_results(phenos = phenos)
agg_results <- function(phenos,
                        count_var = "Phenotype",
                        group_var = "CellType",
                        sep="; ",
                        verbose = TRUE){

  fold_change <- sd_from_mean <- . <- Gene <- NULL;

  # classes <- lapply(phenos, class)
  # phenos[,count=list(
  #   data.table::uniqueN(eval(parse(text = count_var)))
  # ),
  #        ]

  messager("Aggregating results by",
           paste0("group_var=",shQuote(group_var)),v=verbose)
  if(!"Gene" %in% names(phenos)){
    phenos$Gene <- NA
  }
  #### Aggregate ####
  counts_df <- unique(phenos[,.(
    count=data.table::uniqueN(eval(parse(text = count_var))),
    n_genes=data.table::uniqueN(Gene,na.rm = TRUE),
    genes=paste(unique(Gene),collapse = sep),
    mean_fold_change=round(mean(fold_change),3),
    mean_q=round(mean(q),3),
    mean_sd_from_mean=round(mean(sd_from_mean),3),
    values=paste(
      stringr::str_wrap(paste(unique(eval(parse(text = count_var))),
                              collapse = sep)),
      sep = "<br>")
  ),
  by=group_var][,c(group_var,
                   "count",
                   "n_genes",
                   "genes",
                   "mean_fold_change",
                   "mean_q",
                   "mean_sd_from_mean",
                   "values"), with=FALSE])
  data.table::setnames(counts_df,
                       c("count","values"),
                       c(paste("n",tolower(count_var),sep="_"),
                         tolower(count_var)
                       ))

  if(!"HPO_ID" %in% names(counts_df) &&
     "Phenotype" %in% names(counts_df)){
    counts_df <- HPOExplorer::add_hpo_id(phenos = counts_df,
                                         verbose = verbose)
  }
  return(counts_df)
}
